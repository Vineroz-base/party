<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bingo Guest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background:#111;
      color:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      height:100vh;
      overflow:hidden; /* prevent scrolling */
    }
    h1 { margin:12px 0; }
    .hidden { display: none; }
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      width: 90vmin;   /* square grid based on smaller viewport dimension */
      height: 90vmin;
      margin: auto;
    }
    .cell {
      aspect-ratio: 1 / 1;
      display:flex; align-items:center; justify-content:center;
      border: 2px solid #00ffff;
      border-radius: 6px;
      font-weight:700;
      font-size: calc(90vmin / 15); /* scales text relative to grid size */
    }
    .hit { background:#00ffff; color:#111; font-weight:bold; }
    .toolbar { display: flex; gap: 8px; margin: 12px 0; justify-content:center; }
    .called { display: flex; flex-wrap: wrap; gap: 4px; justify-content:center; max-width:90vw; }
    .badge {
      font-size: 14px;
      padding: 4px 8px;
      background:#00ffff;
      color:#111;
      border-radius:999px;
      font-weight:bold;
    }
    .winnerBanner {
      font-size: 20px;
      padding: 8px;
      margin: 8px;
      background: gold;
      color: black;
      border-radius: 6px;
      text-align:center;
    }
    .glow { box-shadow: 0 0 25px #00ffff; border-radius:12px; padding:6px; }
  </style>
</head>
<body>
  <h1>Bingo</h1>
  <div id="wait">Please wait for a new Bingo game to start</div>

  <div id="join" class="hidden">
    <label>
      <span>Name:</span>
      <input id="nameInput" maxlength="30" />
    </label>
    <div class="toolbar">
      <button id="refreshBtn">Refresh grid</button>
      <button id="readyBtn">Ready</button>
    </div>
    <div id="grid" class="grid"></div>
  </div>

  <div id="play" class="hidden">
    <h2 id="playerName"></h2>
    <div id="winnerBanner" class="winnerBanner hidden">ðŸŽ‰ BINGO! You won! ðŸŽ‰</div>
    <div id="gridPlayWrap"><div id="gridPlay" class="grid"></div></div>
    <h3>Numbers drawn</h3>
    <div id="calledList" class="called"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBmj-_hMVfz70jZU67Ugd1aRZodckJUj6A",
      authDomain: "github-party.firebaseapp.com",
      projectId: "github-party",
      storageBucket: "github-party.firebasestorage.app",
      messagingSenderId: "301660898316",
      appId: "1:301660898316:web:ad9166ac91610d16239a29",
      measurementId: "G-Q7RBDS0HVF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Utility functions
    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
    function generateGrid5x5(maxNumber=75){
      const pool=Array.from({length:maxNumber},(_,i)=>i+1);
      shuffle(pool);
      const grid=[];
      for(let r=0;r<5;r++){const row=[];for(let c=0;c<5;c++){row.push(pool[r*5+c]);}grid.push(row);}
      return grid;
    }
    function makeHighlightMask(grid, calledNumbersSet){
      return grid.map(row=>row.map(n=>calledNumbersSet.has(n)));
    }

    // DOM refs
    const waitEl = document.getElementById('wait');
    const joinEl = document.getElementById('join');
    const playEl = document.getElementById('play');
    const nameInput = document.getElementById('nameInput');
    const refreshBtn = document.getElementById('refreshBtn');
    const readyBtn = document.getElementById('readyBtn');
    const gridEl = document.getElementById('grid');
    const gridPlayEl = document.getElementById('gridPlay');
    const gridPlayWrap = document.getElementById('gridPlayWrap');
    const playerNameEl = document.getElementById('playerName');
    const calledListEl = document.getElementById('calledList');
    const winnerBannerEl = document.getElementById('winnerBanner');

    let maxNumber = 75;
    let cardDocRef = null;
    let grid = null;

    // Sign in anonymously
    auth.signInAnonymously().catch(console.error);

    // Get ?game=... from URL
    const urlParams = new URLSearchParams(window.location.search);
    const gameIdFromUrl = urlParams.get("game");
    let gameId = null;

    if (gameIdFromUrl) {
      gameId = gameIdFromUrl;
      db.collection('bingo_games').doc(gameId).onSnapshot(doc => {
        if (!doc.exists) {
          waitEl.textContent = "Game not found.";
          show(waitEl); hide(joinEl); hide(playEl);
          return;
        }
        const data = doc.data();
        maxNumber = data.maxNumber || 75;

        if (data.status === "waiting") {
          const storedCardId = localStorage.getItem("cardId");
          const storedGameId = localStorage.getItem("gameId");
          if (storedCardId && storedGameId === gameId) {
            cardDocRef = db.collection('bingo_cards').doc(storedCardId);
            cardDocRef.get().then(doc => {
              if (doc.exists) {
                const d = doc.data();
                const arr = d.grid || [];
                grid = [];
                for (let r=0;r<5;r++){grid.push(arr.slice(r*5,(r+1)*5));}
                renderPlay();
              } else {
                renderJoin();
              }
            });
          } else {
            grid = generateGrid5x5(maxNumber);
            renderJoin();
          }
        } else if (data.status === "active") {
          const storedCardId = localStorage.getItem("cardId");
          const storedGameId = localStorage.getItem("gameId");
          if (storedCardId && storedGameId === gameId) {
            cardDocRef = db.collection('bingo_cards').doc(storedCardId);
            cardDocRef.get().then(doc => {
              if (doc.exists) {
                const d = doc.data();
                const arr = d.grid || [];
                grid = [];
                for (let r=0;r<5;r++){grid.push(arr.slice(r*5,(r+1)*5));}
                renderPlay();
              } else {
                waitEl.textContent = "Card not found. Please wait for a new game.";
                show(waitEl); hide(joinEl); hide(playEl);
              }
            });
          } else {
            waitEl.textContent = "This game is already started, please wait for a new game.";
            show(waitEl); hide(joinEl); hide(playEl);
          }
        } else {
          waitEl.textContent = "Game finished.";
          localStorage.removeItem("cardId");
          localStorage.removeItem("gameId");
          show(waitEl); hide(joinEl); hide(playEl);
        }
      });
    } else {
      waitEl.textContent = "No game selected. Please use the QR link.";
      show(waitEl); hide(joinEl); hide(playEl);
    }

    function renderJoin(){
      hide(waitEl); show(joinEl);
      renderGridPreview();
      refreshBtn.onclick=()=>{
        grid=generateGrid5x5(maxNumber);
        renderGridPreview();
      };
      readyBtn.onclick=async()=>{
        try {
          const playerName=nameInput.value.trim();
          if(!playerName){alert('Please enter your name');return;}
          if(!gameId){alert('No game selected.');return;}
          const uid=auth.currentUser?auth.currentUser.uid:'anon';
          const cardRef=db.collection('bingo_cards').doc();
          await cardRef.set({
            cardId:cardRef.id,
            playerUid:uid,
            gameId:gameId,
            playerName,
            grid:grid.flat(),
            ready:true,
            winner:false,
            createdAt:firebase.firestore.FieldValue.serverTimestamp()
          });
          cardDocRef=cardRef;
          localStorage.setItem("cardId", cardRef.id);
          localStorage.setItem("gameId", gameId);
          renderPlay();
        } catch(err){
          console.error("Error creating card:",err);
          alert("Failed to join game. Check console for details.");
        }
      };
    }

    function renderGridPreview(){
      gridEl.innerHTML='';
      grid.forEach(row=>{
        row.forEach(n=>{
          const div=document.createElement('div');
          div.className='cell';
          div.textContent=n;
          gridEl.appendChild(div);
        });
      });
    }

    function renderPlay(){
      hide(waitEl); hide(joinEl); show(playEl);
      playerNameEl.textContent = nameInput.value.trim() || 'Guest';

      // Listen to game state
      db.collection('bingo_games').doc(gameId).onSnapshot(doc=>{
        const data = doc.data();
        const called = data.calledNumbers || [];
        const set = new Set(called);
        renderGridPlay(set);
        renderCalledList(called);

        if (data.status === "finished") {
          // Clear local storage when game ends
          localStorage.removeItem("cardId");
          localStorage.removeItem("gameId");
        }
      });

      if(cardDocRef){
        cardDocRef.onSnapshot(doc=>{
          const d = doc.data();
          if (!d) return;
          playerNameEl.textContent = d.playerName;
          // reconstruct grid from flattened array
          const arr = d.grid || [];
          grid = [];
          for(let r=0;r<5;r++){
            grid.push(arr.slice(r*5,(r+1)*5));
          }
          // âœ… Show winner banner and glow effect if card is marked winner
          if (d.winner) {
            show(winnerBannerEl);
            gridPlayWrap.classList.add("glow");
          } else {
            hide(winnerBannerEl);
            gridPlayWrap.classList.remove("glow");
          }
        });
      }
    }

    function renderGridPlay(calledSet){
      gridPlayEl.innerHTML='';
      const mask = makeHighlightMask(grid, calledSet);
      for(let r=0;r<5;r++){
        for(let c=0;c<5;c++){
          const div=document.createElement('div');
          div.className='cell'+(mask[r][c]?' hit':'');
          div.textContent=grid[r][c];
          gridPlayEl.appendChild(div);
        }
      }
    }

    function renderCalledList(called){
      calledListEl.innerHTML='';
      called.forEach(n=>{
        const span=document.createElement('span');
        span.className='badge';
        span.textContent=n;
        calledListEl.appendChild(span);
      });
    }

    function show(el){el.classList.remove('hidden');}
    function hide(el){el.classList.add('hidden');}
  </script>
</body>
</html>
