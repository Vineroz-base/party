<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bingo Guest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background:#111;
      color:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      height:100vh;
      overflow:hidden;
    }
    h1 { margin:12px 0; }
    .hidden { display: none; }
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      width: 90vmin;
      height: 90vmin;
      margin: auto;
    }
    .cell {
      aspect-ratio: 1 / 1;
      display:flex; align-items:center; justify-content:center;
      border: 2px solid #00ffff;
      border-radius: 6px;
      font-weight:700;
      font-size: calc(90vmin / 15);
    }
    .hit { background:#00ffff; color:#111; font-weight:bold; }
    .toolbar { display: flex; gap: 8px; margin: 12px 0; justify-content:center; }
    .called { display: flex; flex-wrap: wrap; gap: 4px; justify-content:center; max-width:90vw; }
    .badge {
      font-size: 14px;
      padding: 4px 8px;
      background:#00ffff;
      color:#111;
      border-radius:999px;
      font-weight:bold;
    }
    .winnerBanner {
      font-size: 20px;
      padding: 8px;
      margin: 8px;
      background: gold;
      color: black;
      border-radius: 6px;
      text-align:center;
    }
    .glow { box-shadow: 0 0 25px #00ffff; border-radius:12px; padding:6px; }

    /* Golden pulse glow for winning cells */
    @keyframes goldenPulse {
      0% { box-shadow: 0 0 10px gold; }
      50% { box-shadow: 0 0 30px gold; }
      100% { box-shadow: 0 0 10px gold; }
    }
    .winningCell {
      background: gold !important;
      color: #111 !important;
      animation: goldenPulse 1s infinite;
    }
  </style>
</head>
<body>
  <h1>Bingo</h1>
  <div id="wait">Please wait for a new Bingo game to start</div>

  <div id="join" class="hidden">
    <label>
      <span>Name:</span>
      <input id="nameInput" maxlength="30" />
    </label>
    <div class="toolbar">
      <button id="refreshBtn">Refresh grid</button>
      <button id="readyBtn">Ready</button>
    </div>
    <div id="grid" class="grid"></div>
  </div>

  <div id="play" class="hidden">
    <h2 id="playerName"></h2>
    <div id="winnerBanner" class="winnerBanner hidden">ðŸŽ‰ BINGO! You won! ðŸŽ‰</div>
    <div id="gridPlayWrap"><div id="gridPlay" class="grid"></div></div>
    <h3>Numbers drawn</h3>
    <div id="calledList" class="called"></div>
  </div>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <!-- Confetti library -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBmj-_hMVfz70jZU67Ugd1aRZodckJUj6A",
      authDomain: "github-party.firebaseapp.com",
      projectId: "github-party",
      storageBucket: "github-party.firebasestorage.app",
      messagingSenderId: "301660898316",
      appId: "1:301660898316:web:ad9166ac91610d16239a29",
      measurementId: "G-Q7RBDS0HVF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Utility functions
    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
    function generateGrid5x5(maxNumber=75){
      const pool=Array.from({length:maxNumber},(_,i)=>i+1);
      shuffle(pool);
      const grid=[];
      for(let r=0;r<5;r++){grid.push(pool.slice(r*5,(r+1)*5));}
      return grid;
    }
    function makeHighlightMask(grid,set){return grid.map(row=>row.map(n=>set.has(n)));}

    function evaluateCard(grid,set){
      const mask=makeHighlightMask(grid,set);
      const lines=[],coords=[];
      for(let r=0;r<5;r++){lines.push(mask[r]); coords.push([[r,0],[r,1],[r,2],[r,3],[r,4]]);}
      for(let c=0;c<5;c++){lines.push(mask.map(row=>row[c])); coords.push([[0,c],[1,c],[2,c],[3,c],[4,c]]);}
      lines.push([0,1,2,3,4].map(i=>mask[i][i])); coords.push([[0,0],[1,1],[2,2],[3,3],[4,4]]);
      lines.push([0,1,2,3,4].map(i=>mask[i][4-i])); coords.push([[0,4],[1,3],[2,2],[3,1],[4,0]]);
      let completed=0,minAway=5,winningCells=[];
      lines.forEach((line,i)=>{
        const hits=line.filter(Boolean).length;
        if(hits===5){completed++; winningCells=coords[i];}
        const away=5-hits;
        if(away<minAway) minAway=away;
      });
      return {completed,minAway,winningCells};
    }

    // DOM refs
    const waitEl=document.getElementById('wait');
    const joinEl=document.getElementById('join');
    const playEl=document.getElementById('play');
    const nameInput=document.getElementById('nameInput');
    const refreshBtn=document.getElementById('refreshBtn');
    const readyBtn=document.getElementById('readyBtn');
    const gridEl=document.getElementById('grid');
    const gridPlayEl=document.getElementById('gridPlay');
    const gridPlayWrap=document.getElementById('gridPlayWrap');
    const playerNameEl=document.getElementById('playerName');
    const calledListEl=document.getElementById('calledList');
    const winnerBannerEl=document.getElementById('winnerBanner');

    let maxNumber=75, cardDocRef=null, grid=null;

    auth.signInAnonymously().catch(console.error);
    const urlParams=new URLSearchParams(window.location.search);
    const gameId=urlParams.get("game");

    // Snapshot handler with fixes
    if(gameId){
      db.collection('bingo_games').doc(gameId).onSnapshot(doc=>{
        if(!doc.exists){
          waitEl.textContent="Game not found.";
          show(waitEl); hide(joinEl); hide(playEl);
          return;
        }
        const data=doc.data();
        maxNumber=data.maxNumber||75;

        const storedCardId=localStorage.getItem("cardId");
        const storedGameId=localStorage.getItem("gameId");

        if(data.status==="waiting"||data.status==="active"){
          if(storedCardId&&storedGameId===gameId){
            cardDocRef=db.collection('bingo_cards').doc(storedCardId);
            cardDocRef.get().then(cd=>{
              if(cd.exists){
                const arr=cd.data().grid||[];
                grid=[]; for(let r=0;r<5;r++){grid.push(arr.slice(r*5,(r+1)*5));}
                renderPlay();
              } else {
                localStorage.clear();
                if(data.status==="waiting"){grid=generateGrid5x5(maxNumber);renderJoin();}
                else {waitEl.textContent="This game is already started, please wait for a new game.";show(waitEl);hide(joinEl);hide(playEl);}
              }
            });
          } else if(data.status==="waiting"){
            grid=generateGrid5x5(maxNumber);
            renderJoin();
          } else {
            waitEl.textContent="This game is already started, please wait for a new game.";
            show(waitEl); hide(joinEl); hide(playEl);
          }
        } else if(data.status==="finished"){
          waitEl.textContent="Game finished.";
          localStorage.clear();
          show(waitEl); hide(joinEl); hide(playEl);
        }
      });
    } else {
      waitEl.textContent="No game selected. Please use the QR link.";
      show(waitEl); hide(joinEl); hide(playEl);
    }

    function renderJoin(){
      hide(waitEl); show(joinEl);
      renderGridPreview();
      refreshBtn.onclick=()=>{
        grid=generateGrid5x5(maxNumber);
        renderGridPreview();
      };
      readyBtn.onclick=async()=>{
        try {
          const playerName=nameInput.value.trim();
          if(!playerName){alert('Please enter your name');return;}
          if(!gameId){alert('No game selected.');return;}
          const uid=auth.currentUser?auth.currentUser.uid:'anon';
          const cardRef=db.collection('bingo_cards').doc();
          await cardRef.set({
            cardId:cardRef.id,
            playerUid:uid,
            gameId:gameId,
            playerName,
            grid:grid.flat(),
            ready:true,
            winner:false,
            createdAt:firebase.firestore.FieldValue.serverTimestamp()
          });
          cardDocRef=cardRef;
          localStorage.setItem("cardId", cardRef.id);
          localStorage.setItem("gameId", gameId);
          renderPlay();
        } catch(err){console.error("Error creating card:",err);}
      };
    }

    function renderGridPreview(){
      gridEl.innerHTML='';
      grid.forEach(row=>{
        row.forEach(n=>{
          const div=document.createElement('div');
          div.className='cell';
          div.textContent=n;
          gridEl.appendChild(div);
        });
      });
    }

    function renderPlay(){
      hide(waitEl); hide(joinEl); show(playEl);
      playerNameEl.textContent=nameInput.value.trim()||'Guest';

      db.collection('bingo_games').doc(gameId).onSnapshot(doc=>{
        const data=doc.data(); if(!data) return;
        const called=data.calledNumbers||[];
        const set=new Set(called);
        const {winningCells}=evaluateCard(grid,set);
        renderGridPlay(set,winningCells);
        renderCalledList(called);
      });

      if(cardDocRef){
        cardDocRef.onSnapshot(doc=>{
          const d=doc.data(); if(!d) return;
          playerNameEl.textContent=d.playerName;
          const arr=d.grid||[];
          grid=[]; for(let r=0;r<5;r++){grid.push(arr.slice(r*5,(r+1)*5));}
          if(d.winner){triggerWinEffects();}
          else {hide(winnerBannerEl);gridPlayWrap.classList.remove("glow");}
        });
      }
    }

    function renderGridPlay(calledSet,winningCells=[]){
      gridPlayEl.innerHTML='';
      const mask=makeHighlightMask(grid,calledSet);
      for(let r=0;r<5;r++){
        for(let c=0;c<5;c++){
          const div=document.createElement('div');
          let cls='cell';
          if(mask[r][c]) cls+=' hit';
          if(winningCells.some(([wr,wc])=>wr===r&&wc===c)) cls+=' winningCell';
          div.className=cls;
          div.textContent=grid[r][c];
          gridPlayEl.appendChild(div);
        }
      }
    }

    function renderCalledList(called){
      calledListEl.innerHTML='';
      called.forEach(n=>{
        const span=document.createElement('span');
        span.className='badge';
        span.textContent=n;
        calledListEl.appendChild(span);
      });
    }

    function triggerWinEffects(){
      show(winnerBannerEl);
      gridPlayWrap.classList.add("glow");
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 }
      });
    }

    function show(el){el.classList.remove('hidden');}
    function hide(el){el.classList.add('hidden');}
  </script>
</body>
</html>
