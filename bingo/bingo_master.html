<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bingo Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#111; color:#fff; }
    .center { display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; text-align:center; }
    .big { font-size:80px; font-weight:700; margin:20px; }
    .bigBtn { font-size:32px; padding:20px 40px; margin-top:20px; }
    .minor { font-size:24px; margin-top:12px; }
    .bigNumber { font-size:120px; font-weight:900; margin:40px; }
    .proximityList { font-size:20px; max-height:50vh; overflow-y:auto; display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; text-align:left; }
    .smallBtn { position:fixed; bottom:20px; right:20px; font-size:20px; padding:10px 20px; }
    .winners { font-size:32px; margin:20px; }
    canvas { margin:20px; }
  </style>
</head>
<body>
  <div id="stageContainer"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBmj-_hMVfz70jZU67Ugd1aRZodckJUj6A",
      authDomain: "github-party.firebaseapp.com",
      projectId: "github-party",
      storageBucket: "github-party.firebasestorage.app",
      messagingSenderId: "301660898316",
      appId: "1:301660898316:web:ad9166ac91610d16239a29",
      measurementId: "G-Q7RBDS0HVF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    auth.signInAnonymously().catch(console.error);

    let gameRef=null, gameId=null, maxNumber=75;
    let unsubscribeCards=null;
    const stageContainer=document.getElementById('stageContainer');

    // QR generator
    async function drawQR(canvas,text){
      const url=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(text)}`;
      const img=new Image(); img.crossOrigin='anonymous';
      img.onload=()=>{const ctx=canvas.getContext('2d'); canvas.width=300; canvas.height=300; ctx.drawImage(img,0,0,300,300);};
      img.src=url;
    }

    // Utility
    function reconstructGrid(flat){const g=[];for(let r=0;r<5;r++){g.push(flat.slice(r*5,(r+1)*5));}return g;}
    function makeHighlightMask(grid,set){return grid.map(row=>row.map(n=>set.has(n)));}
    function evaluateCard(grid,set){
      const mask=makeHighlightMask(grid,set);
      const lines=[];
      for(let r=0;r<5;r++) lines.push(mask[r]);
      for(let c=0;c<5;c++) lines.push(mask.map(row=>row[c]));
      lines.push([0,1,2,3,4].map(i=>mask[i][i]));
      lines.push([0,1,2,3,4].map(i=>mask[i][4-i]));
      let completed=0,minAway=5;
      for(const line of lines){
        const hits=line.filter(Boolean).length;
        if(hits===5) completed++;
        const away=5-hits;
        if(away<minAway) minAway=away;
      }
      return {completed,minAway};
    }

    // Stage renderers
    function renderStageIdle(){
      stageContainer.innerHTML=`
        <div class="center">
          <div class="big">BINGO</div>
          <button id="newGameBtn" class="bigBtn">Start New Game</button>
        </div>`;
      document.getElementById('newGameBtn').onclick=startNewGame;
    }

    function renderStageWaiting(playersReady,joinUrl){
      stageContainer.innerHTML=`
        <div class="center">
          <canvas id="qrCanvas"></canvas>
          <div class="minor">Players ready: ${playersReady}</div>
          <button id="startBtn" class="bigBtn">Start</button>
        </div>`;
      drawQR(document.getElementById('qrCanvas'),joinUrl);
      document.getElementById('startBtn').onclick=startGame;
    }

    function renderStageActive(lastNumber,proximityBuckets){
      stageContainer.innerHTML=`
        <div class="center">
          <div class="bigNumber">${lastNumber||''}</div>
          <div class="proximityList">${renderProximityBuckets(proximityBuckets)}</div>
          <button id="finishBtn" class="smallBtn">Finish</button>
        </div>`;
      document.getElementById('finishBtn').onclick=finishGame;
    }

    function renderStageFinished(winners){
      stageContainer.innerHTML=`
        <div class="center">
          <div class="big">BINGO</div>
          <div class="winners">Winners: ${winners.join(', ')||'—'}</div>
          <button id="newGameBtn" class="bigBtn">Start</button>
        </div>`;
      document.getElementById('newGameBtn').onclick=startNewGame;
    }

    function renderProximityBuckets(buckets){
      let html='';
      Object.entries(buckets).forEach(([label,names])=>{
        html+=`<div><strong>${label}</strong><br>${names.join(', ')||'—'}</div>`;
      });
      return html;
    }

    // Game control
    async function startNewGame(){
      // finish old games and delete old cards
      const oldGames=await db.collection("bingo_games").where("status","in",["waiting","active"]).get();
      for(const doc of oldGames.docs){
        await doc.ref.update({status:"finished",endedAt:firebase.firestore.FieldValue.serverTimestamp()});
        const oldCards=await db.collection("bingo_cards").where("gameId","==",doc.id).get();
        for(const card of oldCards.docs){await card.ref.delete();}
      }
      const ref=db.collection('bingo_games').doc();
      await ref.set({
        gameId:ref.id,status:'waiting',calledNumbers:[],maxNumber:maxNumber,
        createdAt:firebase.firestore.FieldValue.serverTimestamp(),
        startedAt:null,endedAt:null
      });
      gameRef=ref; gameId=ref.id;
      subscribeCards();
      subscribeGame();
    }

    async function startGame(){
      if(!gameRef) return;
      await gameRef.update({status:'active',startedAt:firebase.firestore.FieldValue.serverTimestamp()});
    }

    async function drawNumber(){
      if(!gameRef) return;
      const snap=await gameRef.get(); const data=snap.data();
      const called=data.calledNumbers||[];
      const pool=Array.from({length:maxNumber},(_,i)=>i+1).filter(n=>!called.includes(n));
      if(pool.length===0) return;
      const next=pool[Math.floor(Math.random()*pool.length)];
      await gameRef.update({calledNumbers:[...called,next]});
    }

    async function finishGame(){
      if(!gameRef) return;
      await gameRef.update({status:'finished',endedAt:firebase.firestore.FieldValue.serverTimestamp()});
    }

    // Subscriptions
    function subscribeGame(){
      if(!gameRef) return;
      gameRef.onSnapshot(async doc=>{
        const data=doc.data(); if(!data) return;
        if(data.status==='waiting'){
          const playersReady=(await db.collection('bingo_cards').where('gameId','==',gameId).where('ready','==',true).get()).docs.length;
          const joinUrl=`${location.origin}/party/bingo/bingo.html?game=${gameId}`;
          renderStageWaiting(playersReady,joinUrl);
        } else if(data.status==='active'){
          const called=data.calledNumbers||[];
          const lastNumber=called[called.length-1];
          const set=new Set(called);
          const players=(await db.collection('bingo_cards').where('gameId','==',gameId).where('ready','==',true).get()).docs.map(d=>d.data());
          const buckets={'Winners':[],'1 away':[],'2 away':[],'3 away':[]};
          for(const p of players){
            const grid2D = reconstructGrid(p.grid);
            const { completed, minAway } = evaluateCard(grid2D, set);

            if (completed > 0) {
              buckets['Winners'].push(p.playerName);
              // ✅ Update Firestore card doc so guest sees winner banner
              await db.collection('bingo_cards').doc(p.cardId).update({
                winner: true
              });
            } else if (minAway <= 3) {
              if (minAway === 1) buckets['1 away'].push(p.playerName);
              else if (minAway === 2) buckets['2 away'].push(p.playerName);
              else if (minAway === 3) buckets['3 away'].push(p.playerName);
            }
          }

          renderStageActive(lastNumber, buckets);

          // Allow drawing next number by clicking anywhere or pressing space
          document.body.onclick = drawNumber;
          document.body.onkeyup = (e) => { if (e.code === 'Space') drawNumber(); };

        } else if (data.status === 'finished') {
          const players = (await db.collection('bingo_cards')
            .where('gameId','==',gameId).where('winner','==',true).get()).docs.map(d=>d.data());
          const winners = players.map(p=>p.playerName);
          renderStageFinished(winners);
        } else {
          renderStageIdle();
        }
      });
    }

    function subscribeCards(){
      if(unsubscribeCards) unsubscribeCards();
      unsubscribeCards = db.collection('bingo_cards')
        .where('gameId','==',gameId)
        .where('ready','==',true)
        .onSnapshot(snap=>{
          // we only need count for waiting stage
          const players = snap.docs.map(d=>d.data());
          if(players.length && gameRef){
            gameRef.get().then(doc=>{
              const data=doc.data();
              if(data.status==='waiting'){
                const joinUrl=`${location.origin}/party/bingo/bingo.html?game=${gameId}`;
                renderStageWaiting(players.length,joinUrl);
              }
            });
          }
        });
    }

    // Initial render
    renderStageIdle();
  </script>
</body>
</html>
