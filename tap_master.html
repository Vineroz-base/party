<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tap Race Master</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background: #0f172a; color: #e2e8f0; margin: 0; }
    header { padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; background: #111827; position: sticky; top: 0; }
    h1 { margin: 0; font-size: 22px; }
    .controls { display: flex; gap: 12px; }
    button { padding: 10px 16px; font-size: 16px; border: 0; border-radius: 8px; cursor: pointer; }
    #startBtn { background: #22c55e; color: #022c22; font-weight: 600; }
    #stopBtn  { background: #ef4444; color: #2a0f10; font-weight: 600; }
    #countdown { font-size: 18px; }
    main { padding: 24px; max-width: 1000px; margin: 0 auto; }
    h2 { margin: 12px 0 8px; font-size: 20px; color: #93c5fd; }
    #leaderboard { margin-top: 12px; display: grid; gap: 10px; }
    .row { background: #1f2937; border-radius: 10px; padding: 12px; }
    .topline { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
    .name { font-weight: 700; color: #fef3c7; }
    .score { font-variant-numeric: tabular-nums; color: #a7f3d0; }
    .barwrap { background: #0b1220; border-radius: 6px; overflow: hidden; height: 16px; }
    .bar { height: 100%; background: linear-gradient(90deg, #38bdf8, #22c55e); width: 0%; transition: width 200ms ease; }
    .winner { outline: 3px solid #facc15; box-shadow: 0 0 12px #f59e0b; }
    footer { padding: 12px 24px; color: #94a3b8; text-align: center; }
  </style>
</head>
<body>
  <header>
    <h1>Tap Race Admin</h1>
    <div class="controls">
      <button id="startBtn">Start race</button>
      <button id="stopBtn">Stop race</button>
    </div>
    <div id="countdown">Idle</div>
  </header>

  <main>
    <h2>Leaderboard</h2>
    <div id="leaderboard"></div>
  </main>

  <footer>
    Projector-friendly view. Start/Stop controls sync via Firebase.
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getDatabase, ref, set, update, onValue, get, child
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBmj-_hMVfz70jZU67Ugd1aRZodckJUj6A",
      authDomain: "github-party.firebaseapp.com",
      databaseURL: "https://github-party-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "github-party",
      storageBucket: "github-party.firebasestorage.app",
      messagingSenderId: "301660898316",
      appId: "1:301660898316:web:aee18e9b10d5cf89239a29",
      measurementId: "G-1E7L3P0M2Q"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const startBtn     = document.getElementById("startBtn");
    const stopBtn      = document.getElementById("stopBtn");
    const countdownEl  = document.getElementById("countdown");
    const leaderboardEl= document.getElementById("leaderboard");

    // Configurable duration in seconds
    const raceDurationSeconds = 10;

    // Track current race from DB (source of truth)
    let currentRace = { raceId: null, raceActive: false, duration: raceDurationSeconds, startTime: null, winnerId: null };
    let countdownTimer = null;

    // Subscribe to currentRace to keep local state synced
    const currentRaceRef = ref(db, "tapRace/currentRace");
    onValue(currentRaceRef, (snap) => {
      const val = snap.val() || {};
      currentRace = {
        raceId: val.raceId || null,
        raceActive: !!val.raceActive,
        duration: Number(val.duration || raceDurationSeconds),
        startTime: val.startTime || null,
        winnerId: val.winnerId || null
      };

      // Update UI countdown state if we have startTime
      if (currentRace.raceActive && currentRace.startTime) {
        const endMs = currentRace.startTime + currentRace.duration * 1000;
        const updateCountdown = () => {
          const now = Date.now();
          const leftMs = Math.max(0, endMs - now);
          const left = Math.ceil(leftMs / 1000);
          countdownEl.textContent = `Race ends in ${left}s`;
          if (left <= 0) {
            // If timer slips, stop the race with the active raceId
            clearInterval(countdownTimer);
            stopRace(currentRace.raceId);
          }
        };
        clearInterval(countdownTimer);
        updateCountdown();
        countdownTimer = setInterval(updateCountdown, 1000);
      } else {
        clearInterval(countdownTimer);
        countdownEl.textContent = currentRace.winnerId ? "Race finished!" : "Idle";
      }

      // Highlight winner in leaderboard when race ended
      renderLeaderboard(lastPlayersSnapshot, currentRace);
    });

    // Listen for players and render leaderboard
    let lastPlayersSnapshot = {};
    const playersRef = ref(db, "tapRace/players");
    onValue(playersRef, (snapshot) => {
      lastPlayersSnapshot = snapshot.val() || {};
      renderLeaderboard(lastPlayersSnapshot, currentRace);
    });

    function renderLeaderboard(players, race) {
      const entries = Object.entries(players).map(([uid, p]) => ({
        uid,
        name: p?.name || uid,
        tapCount: Number(p?.tapCount || 0)
      }));
      entries.sort((a, b) => b.tapCount - a.tapCount);

      const max = Math.max(1, ...entries.map(e => e.tapCount));
      leaderboardEl.innerHTML = "";

      for (const e of entries) {
        const row    = document.createElement("div");
        row.className= "row" + (race.winnerId === e.uid && !race.raceActive ? " winner" : "");

        const topline= document.createElement("div");
        topline.className = "topline";

        const nameEl = document.createElement("div");
        nameEl.className = "name";
        nameEl.textContent = e.name;

        const scoreEl = document.createElement("div");
        scoreEl.className = "score";
        scoreEl.textContent = e.tapCount.toString();

        topline.appendChild(nameEl);
        topline.appendChild(scoreEl);

        const barwrap = document.createElement("div");
        barwrap.className = "barwrap";
        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.width = `${Math.round((e.tapCount / max) * 100)}%`;
        barwrap.appendChild(bar);

        row.appendChild(topline);
        row.appendChild(barwrap);
        leaderboardEl.appendChild(row);
      }

      if (entries.length === 0) {
        const empty = document.createElement("div");
        empty.className = "row";
        empty.textContent = "No players yet";
        leaderboardEl.appendChild(empty);
      }
    }

    // Start race: set metadata, reset counts, start countdown
    async function startRace() {
      // Generate raceId (timestamp-based)
      const raceId = new Date().toISOString().replace('T', ' ').slice(0,19).replace(/[-:]/g,'').replace(' ','-');
      const startTime = Date.now();

      // 1) Set race metadata
      await set(currentRaceRef, {
        raceId,
        raceActive: true,
        startTime,
        duration: raceDurationSeconds,
        winnerId: null
      });

      // 2) Reset all players' tapCount to 0
      const snap = await get(playersRef);
      const players = snap.val() || {};
      const updates = {};
      for (const uid of Object.keys(players)) {
        updates[`${uid}/tapCount`] = 0;
      }
      if (Object.keys(updates).length > 0) {
        await update(playersRef, updates);
      }

      // 3) Local countdown will be driven by onValue(currentRaceRef)
    }

    // Stop race: compute winner once and persist results
    async function stopRace(raceIdFromArg = null) {
      const raceId = raceIdFromArg || currentRace.raceId || Date.now().toString();

      // Read players once to compute winner
      const snap = await get(playersRef);
      const players = snap.val() || {};

      let winnerId = null;
      let maxTaps = -1;
      for (const uid of Object.keys(players)) {
        const count = Number(players[uid]?.tapCount || 0);
        if (count > maxTaps) {
          maxTaps = count;
          winnerId = uid;
        }
      }

      // Save results
      await set(ref(db, `tapRace/results/${raceId}`), {
        winnerId,
        scores: players,
        finishedAt: Date.now()
      });

      // Update currentRace
      await update(currentRaceRef, { raceActive: false, winnerId });

      // Clear countdown locally
      clearInterval(countdownTimer);
      countdownEl.textContent = "Race finished!";
    }

    // Button bindings
    startBtn.addEventListener("click", startRace);
    stopBtn.addEventListener("click", () => stopRace());

  </script>
</body>
</html>
