<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tap Race Master</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      background: #0f172a; /* dark mode enforced */
      color: #e2e8f0;
      text-align: center;
    }
    h1 { margin: 20px 0; }
    input[type=number] {
      padding: 8px;
      font-size: 18px;
      width: 100px;
      margin: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      margin: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #qr { margin: 20px auto; }
    #leaderboard { margin-top: 20px; max-width: 800px; margin-left: auto; margin-right: auto; }
    .lane {
      background: #1f2937;
      border-radius: 8px;
      margin: 8px 0;
      padding: 6px;
      position: relative;
    }
    .progress {
      background: linear-gradient(90deg, #38bdf8, #22c55e);
      height: 20px;
      border-radius: 6px;
      transition: width 0.2s ease;
    }
    .winner {
      outline: 3px solid #facc15;
      box-shadow: 0 0 12px #f59e0b;
    }
    #confetti {
      font-size: 32px;
      margin-top: 20px;
      color: #facc15;
    }
  </style>
</head>
<body>
  <h1>Tap Race</h1>

  <!-- Stage containers -->
  <div id="idleStage">
    <p>Enter target taps to win:</p>
    <input type="number" id="targetInput" min="1" value="50">
    <button id="createBtn">Create Race</button>
  </div>

  <div id="waitingStage" style="display:none;">
    <div id="qr"><!-- QR code placeholder --></div>
    <p id="playerCount">Players joined: 0</p>
    <button id="startBtn">Start Game</button>
  </div>

  <div id="activeStage" style="display:none;">
    <h2>Race in progress!</h2>
    <div id="leaderboard"></div>
  </div>

  <div id="finishedStage" style="display:none;">
    <div id="confetti">ðŸŽ‰ðŸŽ‰ðŸŽ‰</div>
    <h2 id="winnerMsg">Congratulations!</h2>
    <button id="restartBtn">Restart Game</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmj-_hMVfz70jZU67Ugd1aRZodckJUj6A",
      authDomain: "github-party.firebaseapp.com",
      databaseURL: "https://github-party-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "github-party",
      storageBucket: "github-party.firebasestorage.app",
      messagingSenderId: "301660898316",
      appId: "1:301660898316:web:aee18e9b10d5cf89239a29",
      measurementId: "G-1E7L3P0M2Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Sign in anonymously so writes are allowed
    signInAnonymously(auth).catch(err => console.error("Auth error:", err));

    const idleStage = document.getElementById("idleStage");
    const waitingStage = document.getElementById("waitingStage");
    const activeStage = document.getElementById("activeStage");
    const finishedStage = document.getElementById("finishedStage");

    const targetInput = document.getElementById("targetInput");
    const createBtn = document.getElementById("createBtn");
    const startBtn = document.getElementById("startBtn");
    const restartBtn = document.getElementById("restartBtn");
    const playerCountEl = document.getElementById("playerCount");
    const leaderboardEl = document.getElementById("leaderboard");
    const winnerMsg = document.getElementById("winnerMsg");

    const currentRaceRef = ref(db, "tapRace/currentRace");
    const playersRef = ref(db, "tapRace/players");

    // Stage rendering
    function showStage(stage) {
      idleStage.style.display = stage === "idle" ? "block" : "none";
      waitingStage.style.display = stage === "waiting" ? "block" : "none";
      activeStage.style.display = stage === "active" ? "block" : "none";
      finishedStage.style.display = stage === "finished" ? "block" : "none";
    }

    // Listen for race state
    onValue(currentRaceRef, (snap) => {
      const race = snap.val();
      if (!race) { showStage("idle"); return; }
      showStage(race.stage);

      if (race.stage === "waiting") {
        onValue(playersRef, (psnap) => {
          const players = psnap.val() || {};
          playerCountEl.textContent = "Players joined: " + Object.keys(players).length;
        });
      }

      if (race.stage === "active") {
        onValue(playersRef, (psnap) => {
          const players = psnap.val() || {};
          const entries = Object.entries(players).map(([uid, p]) => ({
            uid,
            name: p?.name || uid,
            tapCount: Number(p?.tapCount || 0)
          }));
          entries.sort((a,b) => b.tapCount - a.tapCount);
          const max = race.targetTaps;
          leaderboardEl.innerHTML = "";
          entries.slice(0,10).forEach(e => {
            const lane = document.createElement("div");
            lane.className = "lane";
            const progress = document.createElement("div");
            progress.className = "progress";
            progress.style.width = Math.min(100, (e.tapCount/max)*100) + "%";
            lane.textContent = `${e.name} (${e.tapCount})`;
            lane.appendChild(progress);
            leaderboardEl.appendChild(lane);
            if (e.tapCount >= max && race.stage === "active") {
              update(currentRaceRef, { stage: "finished", winnerId: e.uid });
            }
          });
        });
      }

      if (race.stage === "finished") {
        get(playersRef).then((psnap) => {
          const players = psnap.val() || {};
          const winner = players[race.winnerId];
          if (winner) {
            winnerMsg.textContent = `Congratulations ${winner.name}! You won with ${winner.tapCount} taps!`;
          }
        });
      }
    });

    // Button actions
    createBtn.addEventListener("click", () => {
      const target = Number(targetInput.value);
      set(currentRaceRef, {
        stage: "waiting",
        targetTaps: target,
        winnerId: null
      });
    });

    startBtn.addEventListener("click", () => {
      update(currentRaceRef, { stage: "active" });
    });

    restartBtn.addEventListener("click", () => {
      update(currentRaceRef, { stage: "waiting", winnerId: null });
    });
  </script>
</body>
</html>
