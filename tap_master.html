<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tap Race Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background:#111;
      color:#fff;
      height:100vh;
      overflow:hidden;
      position:relative;
    }
    .hidden { display:none !important; }
    .center { display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; }
    #debugLog {
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      max-height:40vh;
      overflow:auto;
      background:#222;
      color:#0f0;
      font-size:12px;
      padding:4px;
      z-index:9999;
    }
    #playersCount {
      margin-top:20px;
      font-size:20px;
    }
    #chart {
      width:90%;
      margin-top:20px;
    }
    .bar {
      background:#00ffff;
      color:#111;
      margin:4px 0;
      padding:4px;
      border-radius:4px;
      transition:width 0.3s;
    }
    .winner {
      background:gold !important;
      color:black !important;
      box-shadow:0 0 20px gold;
    }
    button {
      margin:10px;
      padding:10px 20px;
      font-size:18px;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <!-- Idle -->
  <div id="idle" class="center">
    <h2>Tap Race Master</h2>
    <label>Target taps: <input id="targetInput" type="number" value="50" /></label>
    <button id="createBtn">Create race</button>
  </div>

  <!-- Waiting -->
  <div id="wait" class="center hidden">
    <h2>Waiting for players to join...</h2>
    <canvas id="qrCanvas"></canvas>
    <div id="playersCount">Players joined: 0</div>
    <button id="startBtn">Start race</button>
  </div>

  <!-- Race -->
  <div id="race" class="center hidden">
    <h2>Race in progress!</h2>
    <div id="chart"></div>
  </div>

  <!-- Finished -->
  <div id="finished" class="center hidden">
    <h2>Race finished!</h2>
    <div id="chart"></div>
    <button id="restartBtn">Restart game</button>
  </div>

  <div id="debugLog">Debug panel initialized<br></div>

  <!-- QR code generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    function log(msg){
      const el=document.getElementById("debugLog");
      el.innerHTML += msg+"<br>";
    }
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    const firebaseConfig = {
      apiKey: "AIzaSyBmj-_hMVfz70jZU67Ugd1aRZodckJUj6A",
      authDomain: "github-party.firebaseapp.com",
      databaseURL: "https://github-party-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "github-party",
      storageBucket: "github-party.firebasestorage.app",
      messagingSenderId: "301660898316",
      appId: "1:301660898316:web:aee18e9b10d5cf89239a29",
      measurementId: "G-1E7L3P0M2Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const raceRef = ref(db,"tapRace/currentRace");
    const playersRef = ref(db,"tapRace/players");

    const idleEl=document.getElementById('idle');
    const waitEl=document.getElementById('wait');
    const raceEl=document.getElementById('race');
    const finishedEl=document.getElementById('finished');
    const targetInput=document.getElementById('targetInput');
    const createBtn=document.getElementById('createBtn');
    const startBtn=document.getElementById('startBtn');
    const restartBtn=document.getElementById('restartBtn');
    const playersCount=document.getElementById('playersCount');
    const chartDiv=document.getElementById('chart');
    const qrCanvas=document.getElementById('qrCanvas');

    const qr = new QRious({ element: qrCanvas, size: 200 });

    let raceStage="idle";
    let targetTaps=0;

    // Listen for players joining
    onValue(playersRef,(snap)=>{
      const players=snap.val()||{};
      const count=Object.keys(players).length;
      playersCount.textContent="Players joined: "+count;
      if(raceStage==="active"||raceStage==="finished"){
        renderChart(players);
      }
      log("Players updated, count: "+count);
    });

    // Listen for race state
    onValue(raceRef,(snap)=>{
      const race=snap.val();
      if(!race){ return; }
      raceStage=race.stage;
      targetTaps=race.targetTaps||0;
      log("Race stage: "+raceStage+", targetTaps: "+targetTaps);
      if(raceStage==="idle"){
        show(idleEl); hide(waitEl); hide(raceEl); hide(finishedEl);
      } else if(raceStage==="waiting"){
        hide(idleEl); show(waitEl); hide(raceEl); hide(finishedEl);
        qr.value=window.location.origin+"/tap.html";
      } else if(raceStage==="active"){
        hide(idleEl); hide(waitEl); show(raceEl); hide(finishedEl);
      } else if(raceStage==="finished"){
        hide(idleEl); hide(waitEl); hide(raceEl); show(finishedEl);
        confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
      }
    });

    function renderChart(players){
      chartDiv.innerHTML="";
      const sorted=Object.values(players).sort((a,b)=>b.tapCount-a.tapCount).slice(0,10);
      sorted.forEach(p=>{
        const bar=document.createElement('div');
        const progress=Math.min(100,(p.tapCount/targetTaps)*100);
        bar.className="bar";
        bar.style.width=progress+"%";
        bar.textContent=p.name+" ("+p.tapCount+")";
        if(raceStage==="finished" && p.tapCount>=targetTaps){
          bar.classList.add("winner");
        }
        chartDiv.appendChild(bar);
      });
    }

    createBtn.onclick=()=>{
      set(raceRef,{stage:"waiting",targetTaps:parseInt(targetInput.value)||50});
      remove(playersRef);
      log("Race created, waiting stage");
    };

    startBtn.onclick=()=>{
      const target=parseInt(targetInput.value)||50;
      update(raceRef,{stage:"active",targetTaps:target});
      log("Race started with targetTaps="+target);
    };

    restartBtn.onclick=()=>{
      set(raceRef,{stage:"idle"});
      remove(playersRef);
      log("Race reset to idle");
    };

    // Initialize race state to idle
    set(raceRef,{stage:"idle"});
    remove(playersRef);
    log("Race initialized to idle stage");
  </script>
</body>
</html>
