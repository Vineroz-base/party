<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tap Race Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background:#111;
      color:#fff;
      height:100vh;
      overflow:hidden;
      position:relative;
    }
    .hidden { display:none; }
    .center { display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; }
    #debugLog {
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      max-height:40vh;
      overflow:auto;
      background:#222;
      color:#0f0;
      font-size:12px;
      padding:4px;
      z-index:9999;
    }
    #players {
      margin-top:20px;
      padding:10px;
      background:#222;
      border-radius:6px;
      max-height:40vh;
      overflow:auto;
      width:80%;
    }
    button {
      margin:10px;
      padding:10px 20px;
      font-size:18px;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div id="wait" class="center">
    <h2>Waiting for players to join...</h2>
    <div id="players"></div>
    <label>Target taps: <input id="targetInput" type="number" value="50" /></label>
    <button id="startBtn">Start Game</button>
  </div>

  <div id="race" class="center hidden">
    <h2>Race in progress!</h2>
    <button id="endBtn">End Game</button>
  </div>

  <div id="finished" class="center hidden">
    <h2 id="winnerMsg">Race finished</h2>
    <button id="newBtn">New Game</button>
  </div>

  <div id="debugLog">Debug panel initialized<br></div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    function log(msg){
      const el=document.getElementById("debugLog");
      el.innerHTML += msg+"<br>";
    }

    function show(el){
      el.classList.remove('hidden');
      el.style.display = "flex";
    }
    function hide(el){
      el.classList.add('hidden');
      el.style.display = "none";
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBmj-_hMVfz70jZU67Ugd1aRZodckJUj6A",
      authDomain: "github-party.firebaseapp.com",
      databaseURL: "https://github-party-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "github-party",
      storageBucket: "github-party.firebasestorage.app",
      messagingSenderId: "301660898316",
      appId: "1:301660898316:web:aee18e9b10d5cf89239a29",
      measurementId: "G-1E7L3P0M2Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const raceRef = ref(db,"tapRace/currentRace");
    const playersRef = ref(db,"tapRace/players");

    const waitEl=document.getElementById('wait');
    const raceEl=document.getElementById('race');
    const finishedEl=document.getElementById('finished');
    const playersDiv=document.getElementById('players');
    const targetInput=document.getElementById('targetInput');
    const startBtn=document.getElementById('startBtn');
    const endBtn=document.getElementById('endBtn');
    const newBtn=document.getElementById('newBtn');
    const winnerMsg=document.getElementById('winnerMsg');

    // Listen for players joining
    onValue(playersRef,(snap)=>{
      const players=snap.val()||{};
      playersDiv.innerHTML="";
      Object.values(players).forEach(p=>{
        playersDiv.innerHTML += `<div>${p.name} (taps: ${p.tapCount})</div>`;
      });
      log("Players updated, count: "+Object.keys(players).length);
    });

    // Listen for race state
    onValue(raceRef,(snap)=>{
      const race=snap.val();
      if(!race){ 
        log("No race object yet");
        return;
      }
      log("Race stage: "+race.stage+", targetTaps: "+race.targetTaps);
      if(race.stage==="waiting"){
        show(waitEl); hide(raceEl); hide(finishedEl);
      } else if(race.stage==="active"){
        hide(waitEl); show(raceEl); hide(finishedEl);
      } else if(race.stage==="finished"){
        hide(waitEl); hide(raceEl); show(finishedEl);
        winnerMsg.textContent = race.winnerId ? `Winner UID: ${race.winnerId}` : "Race finished";
      }
    });

    startBtn.onclick=()=>{
      const target=parseInt(targetInput.value)||50;
      update(raceRef,{stage:"active",targetTaps:target});
      log("Game started with targetTaps="+target);
    };

    endBtn.onclick=()=>{
      // Find winner by highest tapCount
      onValue(playersRef,(snap)=>{
        const players=snap.val()||{};
        let winnerId=null, maxTaps=-1;
        Object.entries(players).forEach(([uid,p])=>{
          if(p.tapCount>maxTaps){ maxTaps=p.tapCount; winnerId=uid; }
        });
        update(raceRef,{stage:"finished",winnerId});
        log("Game ended, winner UID="+winnerId+" with taps="+maxTaps);
      },{onlyOnce:true});
    };

    newBtn.onclick=()=>{
      set(raceRef,{stage:"waiting",targetTaps:parseInt(targetInput.value)||50});
      remove(playersRef);
      log("New game initialized");
    };

    // Initialize race state
    set(raceRef,{stage:"waiting",targetTaps:parseInt(targetInput.value)||50});
    remove(playersRef);
    log("Race initialized to waiting stage");
  </script>
</body>
</html>
