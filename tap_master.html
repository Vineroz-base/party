<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tap Race Master</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f9f9f9; }
    h1 { margin-top: 20px; }
    #leaderboard { margin-top: 30px; }
    .player { margin: 5px; padding: 10px; background: #fff; border: 1px solid #ccc; }
    .winner { background: gold; font-weight: bold; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Tap Race Admin</h1>
  <button id="startBtn">Start Race</button>
  <button id="stopBtn">Stop Race</button>
  <div id="countdown"></div>
  <h2>Leaderboard</h2>
  <div id="leaderboard"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmj-_hMVfz70jZU67Ugd1aRZodckJUj6A",
      authDomain: "github-party.firebaseapp.com",
      databaseURL: "https://github-party-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "github-party",
      storageBucket: "github-party.firebasestorage.app",
      messagingSenderId: "301660898316",
      appId: "1:301660898316:web:aee18e9b10d5cf89239a29",
      measurementId: "G-1E7L3P0M2Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const countdownEl = document.getElementById("countdown");
    const leaderboardEl = document.getElementById("leaderboard");

    let raceDuration = 10; // seconds
    let timer;

    // Listen for player updates
    const playersRef = ref(db, "tapRace/players");
    onValue(playersRef, (snapshot) => {
      const players = snapshot.val() || {};
      leaderboardEl.innerHTML = "";
      let winnerId = null;
      let maxTaps = -1;

      Object.keys(players).forEach(uid => {
        const p = players[uid];
        const div = document.createElement("div");
        div.className = "player";
        div.textContent = `${p.name || uid}: ${p.tapCount || 0}`;
        if (p.tapCount > maxTaps) {
          maxTaps = p.tapCount;
          winnerId = uid;
        }
        leaderboardEl.appendChild(div);
      });

      // Highlight winner if race ended
      if (winnerId && raceActive === false) {
        [...leaderboardEl.children].forEach(div => {
          if (div.textContent.startsWith(winnerId) || div.textContent.includes(players[winnerId].name)) {
            div.classList.add("winner");
          }
        });
      }
    });

    let raceActive = false;

    function startRace() {
      raceActive = true;
      const raceId = Date.now().toString();
      set(ref(db, "tapRace/currentRace"), {
        raceId,
        raceActive: true,
        startTime: Date.now(),
        duration: raceDuration,
        winnerId: null
      });

      // Reset all players
      update(playersRef, {}); // clears tap counts

      let timeLeft = raceDuration;
      countdownEl.textContent = `Race ends in ${timeLeft}s`;
      timer = setInterval(() => {
        timeLeft--;
        countdownEl.textContent = `Race ends in ${timeLeft}s`;
        if (timeLeft <= 0) {
          stopRace(raceId);
        }
      }, 1000);
    }

    function stopRace(raceId) {
      clearInterval(timer);
      raceActive = false;
      countdownEl.textContent = "Race finished!";

      // Find winner
      onValue(playersRef, (snapshot) => {
        const players = snapshot.val() || {};
        let winnerId = null;
        let maxTaps = -1;
        Object.keys(players).forEach(uid => {
          if (players[uid].tapCount > maxTaps) {
            maxTaps = players[uid].tapCount;
            winnerId = uid;
          }
        });

        // Save results
        set(ref(db, `tapRace/results/${raceId}`), {
          winnerId,
          scores: players,
          finishedAt: Date.now()
        });

        update(ref(db, "tapRace/currentRace"), {
          raceActive: false,
          winnerId
        });
      }, { onlyOnce: true });
    }

    startBtn.addEventListener("click", startRace);
    stopBtn.addEventListener("click", () => stopRace(Date.now().toString()));
  </script>
</body>
</html>
