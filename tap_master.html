<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tap Race Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#111; color:#fff; }
    .center { display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; text-align:center; }
    .big { font-size:80px; font-weight:700; margin:20px; }
    .bigBtn { font-size:32px; padding:20px 40px; margin-top:20px; }
    .minor { font-size:24px; margin-top:12px; }
    .smallBtn { font-size:20px; padding:10px 20px; margin-top:20px; }
    .winners { font-size:32px; margin:20px; }
    canvas { margin:20px; }
    .toolbar { display:flex; gap:20px; justify-content:center; margin-top:20px; }
    #leaderboard { font-size:20px; max-height:50vh; overflow-y:auto; margin-top:20px; width:80%; }
    .lane { background:#222; border-radius:8px; margin:8px 0; padding:6px; position:relative; }
    .progress { background:linear-gradient(90deg,#38bdf8,#22c55e); height:20px; border-radius:6px; transition:width 0.2s ease; }
    #confetti { font-size:48px; margin:20px; }
  </style>
</head>
<body>
  <div id="stageContainer"></div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmj-_hMVfz70jZU67Ugd1aRZodckJUj6A",
      authDomain: "github-party.firebaseapp.com",
      databaseURL: "https://github-party-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "github-party",
      storageBucket: "github-party.firebasestorage.app",
      messagingSenderId: "301660898316",
      appId: "1:301660898316:web:aee18e9b10d5cf89239a29",
      measurementId: "G-1E7L3P0M2Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    signInAnonymously(auth).catch(console.error);

    const stageContainer = document.getElementById('stageContainer');
    const currentRaceRef = ref(db, "tapRace/currentRace");
    const playersRef = ref(db, "tapRace/players");

    // QR generator (same style as Bingo)
    async function drawQR(canvas,text){
      const url=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(text)}`;
      const img=new Image(); img.crossOrigin='anonymous';
      img.onload=()=>{const ctx=canvas.getContext('2d'); canvas.width=300; canvas.height=300; ctx.drawImage(img,0,0,300,300);};
      img.src=url;
    }

    // Stage renderers
    function renderStageIdle(){
      stageContainer.innerHTML=`
        <div class="center">
          <div class="big">TAP RACE</div>
          <div class="minor">Enter target taps:</div>
          <input type="number" id="targetInput" min="1" value="50" style="font-size:24px; padding:10px; margin-top:12px;">
          <button id="createBtn" class="bigBtn">Create Race</button>
        </div>`;
      document.getElementById('createBtn').onclick=createRace;
    }

    function renderStageWaiting(playersJoined,joinUrl){
      stageContainer.innerHTML=`
        <div class="center">
          <canvas id="qrCanvas"></canvas>
          <div class="minor">Players joined: ${playersJoined}</div>
          <button id="startBtn" class="bigBtn">Start Game</button>
        </div>`;
      drawQR(document.getElementById('qrCanvas'),joinUrl);
      document.getElementById('startBtn').onclick=startGame;
    }

    function renderStageActive(entries,target){
      stageContainer.innerHTML=`
        <div class="center">
          <div class="big">Race in progress!</div>
          <div id="leaderboard"></div>
        </div>`;
      const leaderboard=document.getElementById('leaderboard');
      leaderboard.innerHTML="";
      entries.slice(0,10).forEach(e=>{
        const lane=document.createElement("div");
        lane.className="lane";
        const progress=document.createElement("div");
        progress.className="progress";
        progress.style.width=Math.min(100,(e.tapCount/target)*100)+"%";
        lane.textContent=`${e.name} (${e.tapCount})`;
        lane.appendChild(progress);
        leaderboard.appendChild(lane);
      });
    }

    function renderStageFinished(winnerName,winnerTaps){
      stageContainer.innerHTML=`
        <div class="center">
          <div id="confetti">ðŸŽ‰ðŸŽ‰ðŸŽ‰</div>
          <div class="winners">Winner: ${winnerName} (${winnerTaps} taps)</div>
          <button id="restartBtn" class="bigBtn">Restart</button>
        </div>`;
      document.getElementById('restartBtn').onclick=restartGame;
    }

    // Actions
    function createRace(){
      const target=Number(document.getElementById('targetInput').value);
      set(currentRaceRef,{stage:"waiting",targetTaps:target,winnerId:null});
    }
    function startGame(){ update(currentRaceRef,{stage:"active"}); }
    function restartGame(){ update(currentRaceRef,{stage:"waiting",winnerId:null}); }

    // Subscriptions
    onValue(currentRaceRef,(snap)=>{
      const race=snap.val();
      if(!race){ renderStageIdle(); return; }
      if(race.stage==="waiting"){
        onValue(playersRef,(psnap)=>{
          const players=psnap.val()||{};
          const joinUrl=`${location.origin}/party/tap.html`; // fixed path
          renderStageWaiting(Object.keys(players).length,joinUrl);
        });
      } else if(race.stage==="active"){
        onValue(playersRef,(psnap)=>{
          const players=psnap.val()||{};
          const entries=Object.entries(players).map(([uid,p])=>({
            uid,name:p?.name||uid,tapCount:Number(p?.tapCount||0)
          }));
          entries.sort((a,b)=>b.tapCount-a.tapCount);
          renderStageActive(entries,race.targetTaps);
          const winner=entries.find(e=>e.tapCount>=race.targetTaps);
          if(winner && race.stage==="active"){
            update(currentRaceRef,{stage:"finished",winnerId:winner.uid});
          }
        });
      } else if(race.stage==="finished"){
        get(playersRef).then(psnap=>{
          const players=psnap.val()||{};
          const winner=players[race.winnerId];
          if(winner){ renderStageFinished(winner.name,winner.tapCount); }
        });
      } else {
        renderStageIdle();
      }
    });

    // Initial render
    renderStageIdle();
  </script>
</body>
</html>
