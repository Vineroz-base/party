<!DOCTYPE html>
<html>
  <head>
    <title>Random Number</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body {
        background-color: #121212;
        color: #f5f5f5;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        font-family: Arial, sans-serif;
      }
      .number { font-size: 36vw; }
      .message {
        font-size: 4vw;
        font-style: italic;
        margin-top: 10px;
        color: #ffcc00;
        text-align: center;
      }
      .button {
        margin-top: 30px;
        padding: 15px 30px;
        font-size: 6vw;
        font-weight: bold;
        color: #121212;
        background-color: #ffcc00;
        border: none;
        border-radius: 10px;
        cursor: pointer;
      }
      .button:hover { background-color: #ffaa00; }
    </style>
  </head>
  <body>
    <div class="number" id="number"></div>
    <div class="message" id="message"></div>
    <button class="button" onclick="window.location.href='card.html'">
      Go to Card Draw
    </button>

    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyBmj-_hMVfz70jZU67Ugd1aRZodckJUj6A",
        authDomain: "github-party.firebaseapp.com",
        projectId: "github-party",
        storageBucket: "github-party.firebasestorage.app",
        messagingSenderId: "301660898316",
        appId: "1:301660898316:web:e00213dcb75fb991239a29",
        measurementId: "G-VYW87HHBK5"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const STORAGE_KEY_NUM = "randomNumber";
      const STORAGE_KEY_TIME = "randomNumberTime";
      const STORAGE_KEY_DOC = "randomNumberDoc"; // store Firestore doc ID
      const DURATION = 30 * 60 * 1000; // 30 minutes

      const now = Date.now();
      let number, timestamp, docRef;

      const storedNumber = localStorage.getItem(STORAGE_KEY_NUM);
      const storedTime = localStorage.getItem(STORAGE_KEY_TIME);
      const storedDoc = localStorage.getItem(STORAGE_KEY_DOC);

      if (storedNumber && storedTime && (now - storedTime < DURATION)) {
        number = parseInt(storedNumber, 10);
        timestamp = parseInt(storedTime, 10);
        if (storedDoc) {
          docRef = db.collection("results").doc(storedDoc);
          attachDocListener(docRef);
        }
      } else {
        number = Math.floor(Math.random() * 100) + 1;
        timestamp = now;
        db.collection("results").add({
          number: number,
          timestamp: new Date(timestamp).toISOString()
        })
        .then(doc => {
          localStorage.setItem(STORAGE_KEY_NUM, number);
          localStorage.setItem(STORAGE_KEY_TIME, timestamp);
          localStorage.setItem(STORAGE_KEY_DOC, doc.id);
          docRef = doc;
          attachDocListener(docRef);
          console.log("Saved:", number);
        })
        .catch(err => console.error("Error:", err));
      }

      // Show number
      document.getElementById("number").textContent = number;

      function updateCountdown() {
        const remaining = (timestamp + DURATION) - Date.now();
        if (remaining <= 0) {
          document.getElementById("message").textContent =
            "Expired â€” refresh for a new number!";
          return;
        }
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        document.getElementById("message").textContent =
          `${minutes.toString().padStart(2,"0")}:${seconds.toString().padStart(2,"0")}`;
      }

      updateCountdown();
      setInterval(updateCountdown, 1000);

      // Listener for own document
      function attachDocListener(docRef) {
        docRef.onSnapshot(snapshot => {
          if (!snapshot.exists) {
            console.log("Record deleted by admin, resetting...");
            resetLocal();
          }
        });
      }

      // Listener for global reset flag
      db.collection("control").doc("resetFlag").onSnapshot(snapshot => {
        if (snapshot.exists) {
          const data = snapshot.data();
          if (data.reset === true) {
            console.log("Global reset triggered, clearing...");
            resetLocal();
          }
        }
      });

      // Clear local storage and reload
      function resetLocal() {
        localStorage.removeItem(STORAGE_KEY_NUM);
        localStorage.removeItem(STORAGE_KEY_TIME);
        localStorage.removeItem(STORAGE_KEY_DOC);
        location.reload();
      }
    </script>
  </body>
</html>
